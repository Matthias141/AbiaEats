# AbiaEats - Fix CSP blocking Supabase signup

$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
Set-Location $ScriptDir
Write-Host "Applying CSP fix..." -ForegroundColor Cyan

[System.IO.File]::WriteAllBytes((Join-Path $ScriptDir "src\lib\supabase\middleware.ts"), [System.Convert]::FromBase64String("aW1wb3J0IHsgY3JlYXRlU2VydmVyQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3Nzcic7CmltcG9ydCB7IE5leHRSZXNwb25zZSwgdHlwZSBOZXh0UmVxdWVzdCB9IGZyb20gJ25leHQvc2VydmVyJzsKCi8qKgogKiBGSVg6IE1FRC0zIOKAlCBDU1AgdW5zYWZlLWlubGluZSBvbiBzY3JpcHQtc3JjCiAqCiAqIEhvdyBub25jZS1iYXNlZCBDU1Agd29ya3M6CiAqIDEuIE1pZGRsZXdhcmUgZ2VuZXJhdGVzIGEgY3J5cHRvZ3JhcGhpY2FsbHkgcmFuZG9tIG5vbmNlIHBlciByZXF1ZXN0CiAqIDIuIFRoZSBub25jZSBpcyBlbWJlZGRlZCBpbiB0aGUgQ1NQIGhlYWRlcjogc2NyaXB0LXNyYyAnbm9uY2UtPHZhbHVlPicKICogMy4gTmV4dC5qcyByZWFkcyB0aGUgbm9uY2UgZnJvbSB0aGUgcmVzcG9uc2UgaGVhZGVyIGFuZCBhdHRhY2hlcyBpdAogKiAgICB0byBldmVyeSBpbmxpbmUgPHNjcmlwdD4gaXQgZ2VuZXJhdGVzIGR1cmluZyBTU1IKICogNC4gVGhlIGJyb3dzZXIgb25seSBleGVjdXRlcyBzY3JpcHRzIHdob3NlIG5vbmNlIGF0dHJpYnV0ZSBtYXRjaGVzIHRoZSBoZWFkZXIKICogNS4gQW4gYXR0YWNrZXIgd2hvIGluamVjdHMgPHNjcmlwdD5ldmlsKCk8L3NjcmlwdD4gaGFzIG5vIG5vbmNlIOKGkiBibG9ja2VkCiAqCiAqIElOVEVSTiBFWFBMQUlORVI6CiAqIFRoaW5rIG9mIGl0IGFzIGEgd3Jpc3RiYW5kIGF0IGEgcGFydHkuIE9ubHkgZ3Vlc3RzIHdpdGggdGhlIHJpZ2h0IHdyaXN0YmFuZAogKiBnZXQgaW4uIFRoZSBwYXJ0eSBob3N0IChOZXh0LmpzKSBoYW5kcyBvdXQgd3Jpc3RiYW5kcy4gSWYgc29tZW9uZSBzbmVha3MgaW4KICogd2l0aG91dCBvbmUsIHRoZSBib3VuY2VyIChicm93c2VyKSB0aHJvd3MgdGhlbSBvdXQuCiAqCiAqIE5leHQuanMgMTUgcmVhZHMgdGhlIG5vbmNlIGZyb20gdGhlIGB4LW5vbmNlYCByZXNwb25zZSBoZWFkZXIgYXV0b21hdGljYWxseQogKiB3aGVuIHlvdSBzZXQgaXQgaW4gbWlkZGxld2FyZSDigJQgbm8gbGF5b3V0IGNoYW5nZXMgbmVlZGVkLgogKi8KCmZ1bmN0aW9uIGdlbmVyYXRlTm9uY2UoKTogc3RyaW5nIHsKICAvLyAxNiBieXRlcyA9IDEyOCBiaXRzIG9mIGVudHJvcHkg4oCUIHdlbGwgYWJvdmUgTklTVCBTUCA4MDAtOTBBIG1pbmltdW0KICBjb25zdCBhcnJheSA9IG5ldyBVaW50OEFycmF5KDE2KTsKICBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKGFycmF5KTsKICByZXR1cm4gQnVmZmVyLmZyb20oYXJyYXkpLnRvU3RyaW5nKCdiYXNlNjQnKTsKfQoKZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVNlc3Npb24ocmVxdWVzdDogTmV4dFJlcXVlc3QpIHsKICAvLyDilIDilIAgU3RlcCAxOiBHZW5lcmF0ZSBub25jZSBmb3IgdGhpcyByZXF1ZXN0IOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogIGNvbnN0IG5vbmNlID0gZ2VuZXJhdGVOb25jZSgpOwoKICBjb25zdCBzdXBhYmFzZVVybCA9IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCB8fCAnaHR0cHM6Ly8qLnN1cGFiYXNlLmNvJzsKICBjb25zdCBzdXBhYmFzZVdzcyA9IHN1cGFiYXNlVXJsLnJlcGxhY2UoL15odHRwcz86XC9cLy8sICd3c3M6Ly8nKTsKCiAgLy8g4pSA4pSAIFN0ZXAgMjogQnVpbGQgQ1NQIHdpdGggbm9uY2Ug4oCUIE5PIHVuc2FmZS1pbmxpbmUgb24gc2NyaXB0LXNyYyDilIDilIDilIDilIDilIDilIDilIDilIAKICBjb25zdCBjc3AgPSBbCiAgICAiZGVmYXVsdC1zcmMgJ3NlbGYnIiwKICAgIC8vIG5vbmNlLWJhc2VkOiBvbmx5IHNjcmlwdHMgTmV4dC5qcyBzdGFtcHMgd2l0aCB0aGlzIG5vbmNlIGFyZSBhbGxvd2VkCiAgICBgc2NyaXB0LXNyYyAnc2VsZicgJ25vbmNlLSR7bm9uY2V9J2AsCiAgICBgY29ubmVjdC1zcmMgJ3NlbGYnIGh0dHBzOi8vKi5zdXBhYmFzZS5jbyB3c3M6Ly8qLnN1cGFiYXNlLmNvIGh0dHBzOi8vYXBpLmFudGhyb3BpYy5jb21gLAogICAgImltZy1zcmMgJ3NlbGYnIGRhdGE6IGJsb2I6IGh0dHBzOi8vKi5zdXBhYmFzZS5jbyIsCiAgICAiZm9udC1zcmMgJ3NlbGYnIGh0dHBzOi8vZm9udHMuZ3N0YXRpYy5jb20iLAogICAgLy8gc3R5bGUtc3JjIHN0aWxsIG5lZWRzIHVuc2FmZS1pbmxpbmUgKENTUy1pbi1KUywgVGFpbHdpbmQpIOKAlCBhY2NlcHRhYmxlIHRyYWRlLW9mZgogICAgLy8gU3R5bGUgaW5qZWN0aW9uIGF0dGFja3MgYXJlIGZhciBsZXNzIGRhbmdlcm91cyB0aGFuIHNjcmlwdCBpbmplY3Rpb24KICAgICJzdHlsZS1zcmMgJ3NlbGYnICd1bnNhZmUtaW5saW5lJyBodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tIiwKICAgICJiYXNlLXVyaSAnc2VsZiciLAogICAgImZvcm0tYWN0aW9uICdzZWxmJyIsCiAgICAiZnJhbWUtYW5jZXN0b3JzICdub25lJyIsCiAgXS5qb2luKCc7ICcpOwoKICAvLyDilIDilIAgU3RlcCAzOiBCdWlsZCB0aGUgcmVzcG9uc2UsIGluamVjdCBDU1AgKyBub25jZSBoZWFkZXJzIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgAogIGxldCBzdXBhYmFzZVJlc3BvbnNlID0gTmV4dFJlc3BvbnNlLm5leHQoeyByZXF1ZXN0IH0pOwogIHN1cGFiYXNlUmVzcG9uc2UuaGVhZGVycy5zZXQoJ0NvbnRlbnQtU2VjdXJpdHktUG9saWN5JywgY3NwKTsKICAvLyBOZXh0LmpzIDE1IHJlYWRzIHgtbm9uY2UgYW5kIHN0YW1wcyBpdCBvbiBhbGwgU1NSLWdlbmVyYXRlZCBpbmxpbmUgc2NyaXB0cwogIHN1cGFiYXNlUmVzcG9uc2UuaGVhZGVycy5zZXQoJ3gtbm9uY2UnLCBub25jZSk7CgogIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlU2VydmVyQ2xpZW50KAogICAgc3VwYWJhc2VVcmwsCiAgICBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9BTk9OX0tFWSB8fCAncGxhY2Vob2xkZXIta2V5JywKICAgIHsKICAgICAgY29va2llczogewogICAgICAgIGdldEFsbCgpIHsKICAgICAgICAgIHJldHVybiByZXF1ZXN0LmNvb2tpZXMuZ2V0QWxsKCk7CiAgICAgICAgfSwKICAgICAgICBzZXRBbGwoY29va2llc1RvU2V0KSB7CiAgICAgICAgICBjb29raWVzVG9TZXQuZm9yRWFjaCgoeyBuYW1lLCB2YWx1ZSB9KSA9PgogICAgICAgICAgICByZXF1ZXN0LmNvb2tpZXMuc2V0KG5hbWUsIHZhbHVlKQogICAgICAgICAgKTsKICAgICAgICAgIHN1cGFiYXNlUmVzcG9uc2UgPSBOZXh0UmVzcG9uc2UubmV4dCh7IHJlcXVlc3QgfSk7CiAgICAgICAgICAvLyBSZS1hcHBseSBzZWN1cml0eSBoZWFkZXJzIGFmdGVyIHJlc3BvbnNlIHJlYnVpbGQKICAgICAgICAgIHN1cGFiYXNlUmVzcG9uc2UuaGVhZGVycy5zZXQoJ0NvbnRlbnQtU2VjdXJpdHktUG9saWN5JywgY3NwKTsKICAgICAgICAgIHN1cGFiYXNlUmVzcG9uc2UuaGVhZGVycy5zZXQoJ3gtbm9uY2UnLCBub25jZSk7CiAgICAgICAgICBjb29raWVzVG9TZXQuZm9yRWFjaCgoeyBuYW1lLCB2YWx1ZSwgb3B0aW9ucyB9KSA9PgogICAgICAgICAgICBzdXBhYmFzZVJlc3BvbnNlLmNvb2tpZXMuc2V0KG5hbWUsIHZhbHVlLCBvcHRpb25zKQogICAgICAgICAgKTsKICAgICAgICB9LAogICAgICB9LAogICAgfQogICk7CgogIGNvbnN0IHsKICAgIGRhdGE6IHsgdXNlciB9LAogIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIoKTsKCiAgY29uc3QgeyBwYXRobmFtZSB9ID0gcmVxdWVzdC5uZXh0VXJsOwoKICAvLyBQdWJsaWMgcm91dGVzIHRoYXQgZG9uJ3QgcmVxdWlyZSBhdXRoZW50aWNhdGlvbgogIGNvbnN0IHB1YmxpY1JvdXRlcyA9IFsnLycsICcvYXV0aC9sb2dpbicsICcvYXV0aC9zaWdudXAnLCAnL2F1dGgvY2FsbGJhY2snLCAnL2hvbWUnLCAnL29uYm9hcmRpbmcnLCAnL3ByaXZhY3ktcG9saWN5J107CiAgY29uc3QgaXNQdWJsaWNSb3V0ZSA9IHB1YmxpY1JvdXRlcy5pbmNsdWRlcyhwYXRobmFtZSk7CiAgY29uc3QgaXNBcGlSb3V0ZSA9IHBhdGhuYW1lLnN0YXJ0c1dpdGgoJy9hcGkvJyk7CiAgY29uc3QgaXNTdGF0aWNBc3NldCA9IHBhdGhuYW1lLnN0YXJ0c1dpdGgoJy9fbmV4dC8nKSB8fCBwYXRobmFtZS5pbmNsdWRlcygnLicpOwoKICAvLyBBbGxvdyBwdWJsaWMgcm91dGVzLCBBUEkgcm91dGVzLCBhbmQgc3RhdGljIGFzc2V0cwogIGlmIChpc1B1YmxpY1JvdXRlIHx8IGlzQXBpUm91dGUgfHwgaXNTdGF0aWNBc3NldCkgewogICAgcmV0dXJuIHN1cGFiYXNlUmVzcG9uc2U7CiAgfQoKICAvLyBDdXN0b21lci1mYWNpbmcgcmVzdGF1cmFudCBicm93c2luZyBpcyBwdWJsaWMKICBpZiAocGF0aG5hbWUuc3RhcnRzV2l0aCgnL3Jlc3RhdXJhbnRzJykpIHsKICAgIHJldHVybiBzdXBhYmFzZVJlc3BvbnNlOwogIH0KCiAgLy8gUmVkaXJlY3QgdW5hdXRoZW50aWNhdGVkIHVzZXJzIHRvIGxvZ2luCiAgaWYgKCF1c2VyKSB7CiAgICBjb25zdCB1cmwgPSByZXF1ZXN0Lm5leHRVcmwuY2xvbmUoKTsKICAgIHVybC5wYXRobmFtZSA9ICcvYXV0aC9sb2dpbic7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgncmVkaXJlY3RUbycsIHBhdGhuYW1lKTsKICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QodXJsKTsKICB9CgogIC8vIFJvbGUtYmFzZWQgcm91dGUgcHJvdGVjdGlvbgogIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKCcvYWRtaW4nKSB8fCBwYXRobmFtZS5zdGFydHNXaXRoKCcvcmVzdGF1cmFudCcpKSB7CiAgICBjb25zdCB7IGRhdGE6IHByb2ZpbGUgfSA9IGF3YWl0IHN1cGFiYXNlCiAgICAgIC5mcm9tKCdwcm9maWxlcycpCiAgICAgIC5zZWxlY3QoJ3JvbGUnKQogICAgICAuZXEoJ2lkJywgdXNlci5pZCkKICAgICAgLnNpbmdsZSgpOwoKICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKCcvYWRtaW4nKSAmJiBwcm9maWxlPy5yb2xlICE9PSAnYWRtaW4nKSB7CiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QobmV3IFVSTCgnLycsIHJlcXVlc3QudXJsKSk7CiAgICB9CgogICAgaWYgKAogICAgICBwYXRobmFtZS5zdGFydHNXaXRoKCcvcmVzdGF1cmFudCcpICYmCiAgICAgIHByb2ZpbGU/LnJvbGUgIT09ICdyZXN0YXVyYW50X293bmVyJyAmJgogICAgICBwcm9maWxlPy5yb2xlICE9PSAnYWRtaW4nCiAgICApIHsKICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZWRpcmVjdChuZXcgVVJMKCcvJywgcmVxdWVzdC51cmwpKTsKICAgIH0KICB9CgogIHJldHVybiBzdXBhYmFzZVJlc3BvbnNlOwp9Cg=="))
Write-Host "  [1/1] src/lib/supabase/middleware.ts" -ForegroundColor Green

git add -A
git commit -m "fix: hardcode Supabase wildcard in CSP connect-src"
git push
Write-Host "Done. Try signing up again after Vercel redeploys." -ForegroundColor Green