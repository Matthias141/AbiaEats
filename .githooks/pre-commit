#!/bin/sh
# AbiaEats pre-commit hook — blocks secret files and detects credentials.
#
# Installation (one-time per developer):
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit
#
# Or run: npm run setup-hooks (if added to package.json)

set -e

# ── 1. Block staged .env files ────────────────────────────────────────────────
STAGED_ENV=$(git diff --cached --name-only | grep -E "(^|\/)\.env(\.|$)" | grep -v "\.example$" || true)
if [ -n "$STAGED_ENV" ]; then
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║  ❌  COMMIT BLOCKED: Secret file detected in staging area   ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "  Staged file(s) that must NOT be committed:"
  echo "$STAGED_ENV" | sed 's/^/    /'
  echo ""
  echo "  These files contain real credentials. Remove them:"
  echo "    git reset HEAD <file>"
  echo "    (or: git restore --staged <file>)"
  echo ""
  exit 1
fi

# ── 2. Run gitleaks if installed ──────────────────────────────────────────────
if command -v gitleaks > /dev/null 2>&1; then
  if ! gitleaks protect --staged --redact -v 2>&1; then
    echo ""
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║  ❌  COMMIT BLOCKED: gitleaks detected potential secrets     ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""
    echo "  Review the output above and remove any credentials before committing."
    echo "  If this is a false positive, see .gitleaks.toml for allowlisting."
    echo ""
    exit 1
  fi
else
  echo "⚠  gitleaks not installed — skipping secret scan."
  echo "   Install with: brew install gitleaks  (or: go install github.com/zricethezav/gitleaks/v8@latest)"
fi

exit 0
